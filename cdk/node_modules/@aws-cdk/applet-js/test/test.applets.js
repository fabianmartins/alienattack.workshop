"use strict";
const child_process = require("child_process");
const fs = require("fs");
const os = require("os");
const path = require("path");
function expectMatch(test, expectedFile, stack) {
    try {
        const expected = JSON.parse(fs.readFileSync(expectedFile, { encoding: 'utf-8' }));
        test.deepEqual(stack, expected);
    }
    catch (e) {
        if (e.code === 'ENOENT') {
            // tslint:disable-next-line:no-console
            console.log(JSON.stringify(stack, undefined, 2));
            throw new Error(`Make a file ${expectedFile} with the previous contents`);
        }
    }
}
function synthesizeApplet(yamlFile, direct = false) {
    // Can't depend on aws-cdk here, so we're reimplementing cx-api.
    // tslint:disable-next-line:no-console
    console.log('Writing to ', os.tmpdir());
    const command = direct ? yamlFile : 'cdk-applet-js';
    const args = direct ? [] : [yamlFile];
    const outdir = fs.mkdtempSync(path.join(os.tmpdir(), 'cdk-applet-tests'));
    child_process.execFileSync(command, args, {
        env: Object.assign({}, process.env, { CDK_OUTDIR: outdir, PATH: 'bin:' + process.env.PATH })
    });
    return JSON.parse(fs.readFileSync(path.join(outdir, 'cdk.out'), { encoding: 'utf-8' }));
}
function getStack(stackName, allStacks) {
    for (const stack of allStacks.stacks) {
        if (stack.name === stackName) {
            return stripStackMetadata(stack);
        }
    }
    // tslint:disable-next-line:no-console
    console.log(allStacks);
    throw new Error('Could not find stack: ' + stackName);
}
function stripStackMetadata(stack) {
    for (const key of Object.keys(stack.metadata)) {
        if (!stack.metadata[key]) {
            continue;
        }
        for (const entry of stack.metadata[key]) {
            if (entry.trace) {
                entry.trace = ['**REDACTED**'];
            }
        }
    }
    delete stack.environment;
    return stack;
}
module.exports = {
    'basic test 1'(test) {
        expectMatch(test, 'test/expected1.json', getStack('TestApplet', synthesizeApplet('test/test1.yaml')));
        test.done();
    },
    'basic test 2'(test) {
        expectMatch(test, 'test/expected2.json', getStack('TestApplet', synthesizeApplet('test/test2.yaml')));
        test.done();
    },
    'can use shebang'(test) {
        fs.chmodSync('test/test3.yaml', 0o755);
        expectMatch(test, 'test/expected3.json', getStack('Applet', synthesizeApplet('test/test3.yaml', true)));
        test.done();
    },
    'test non stack construct'(test) {
        expectMatch(test, 'test/test-nonstack-expected.json', getStack('NoStackApplet', synthesizeApplet('test/test-nonstack.yaml')));
        test.done();
    },
    'test multiple stacks'(test) {
        expectMatch(test, 'test/test-multistack-expected.json', getStack('Stack2', synthesizeApplet('test/test-multistack.yaml')));
        test.done();
    },
    'expect failure 4'(test) {
        test.throws(() => {
            synthesizeApplet('test/negative-test4.yaml');
        }, /but it must be in the form/);
        test.done();
    },
    'expect failure 5'(test) {
        test.throws(() => {
            synthesizeApplet('test/negative-test5.yaml');
        }, /Cannot find module/);
        test.done();
    },
    'expect failure 6'(test) {
        test.throws(() => {
            synthesizeApplet('test/negative-test6.yaml');
        }, /Cannot find applet class/);
        test.done();
    },
    'expect failure 7'(test) {
        test.throws(() => {
            synthesizeApplet('test/negative-test7.yaml');
        }, /but it must be in the form/);
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5hcHBsZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC5hcHBsZXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwrQ0FBZ0Q7QUFDaEQseUJBQTBCO0FBRTFCLHlCQUEwQjtBQUMxQiw2QkFBOEI7QUEwRDlCLFNBQVMsV0FBVyxDQUFDLElBQVUsRUFBRSxZQUFvQixFQUFFLEtBQVU7SUFDL0QsSUFBSTtRQUNGLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2xGLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQ2pDO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixJQUFJLENBQUMsQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQ3ZCLHNDQUFzQztZQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pELE1BQU0sSUFBSSxLQUFLLENBQUMsZUFBZSxZQUFZLDZCQUE2QixDQUFDLENBQUM7U0FDM0U7S0FDRjtBQUNILENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLFFBQWdCLEVBQUUsTUFBTSxHQUFHLEtBQUs7SUFDeEQsZ0VBQWdFO0lBQ2hFLHNDQUFzQztJQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUV4QyxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDO0lBQ3BELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEs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aGlsZF9wcm9jZXNzJyk7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ25vZGV1bml0JztcbmltcG9ydCBvcyA9IHJlcXVpcmUoJ29zJyk7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuZXhwb3J0ID0ge1xuICAnYmFzaWMgdGVzdCAxJyh0ZXN0OiBUZXN0KSB7XG4gICAgZXhwZWN0TWF0Y2godGVzdCwgJ3Rlc3QvZXhwZWN0ZWQxLmpzb24nLCBnZXRTdGFjaygnVGVzdEFwcGxldCcsIHN5bnRoZXNpemVBcHBsZXQoJ3Rlc3QvdGVzdDEueWFtbCcpKSk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ2Jhc2ljIHRlc3QgMicodGVzdDogVGVzdCkge1xuICAgIGV4cGVjdE1hdGNoKHRlc3QsICd0ZXN0L2V4cGVjdGVkMi5qc29uJywgZ2V0U3RhY2soJ1Rlc3RBcHBsZXQnLCBzeW50aGVzaXplQXBwbGV0KCd0ZXN0L3Rlc3QyLnlhbWwnKSkpO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICdjYW4gdXNlIHNoZWJhbmcnKHRlc3Q6IFRlc3QpIHtcbiAgICBmcy5jaG1vZFN5bmMoJ3Rlc3QvdGVzdDMueWFtbCcsIDBvNzU1KTtcbiAgICBleHBlY3RNYXRjaCh0ZXN0LCAndGVzdC9leHBlY3RlZDMuanNvbicsIGdldFN0YWNrKCdBcHBsZXQnLCBzeW50aGVzaXplQXBwbGV0KCd0ZXN0L3Rlc3QzLnlhbWwnLCB0cnVlKSkpO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICd0ZXN0IG5vbiBzdGFjayBjb25zdHJ1Y3QnKHRlc3Q6IFRlc3QpIHtcbiAgICBleHBlY3RNYXRjaCh0ZXN0LCAndGVzdC90ZXN0LW5vbnN0YWNrLWV4cGVjdGVkLmpzb24nLCBnZXRTdGFjaygnTm9TdGFja0FwcGxldCcsIHN5bnRoZXNpemVBcHBsZXQoJ3Rlc3QvdGVzdC1ub25zdGFjay55YW1sJykpKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAndGVzdCBtdWx0aXBsZSBzdGFja3MnKHRlc3Q6IFRlc3QpIHtcbiAgICBleHBlY3RNYXRjaCh0ZXN0LCAndGVzdC90ZXN0LW11bHRpc3RhY2stZXhwZWN0ZWQuanNvbicsIGdldFN0YWNrKCdTdGFjazInLCBzeW50aGVzaXplQXBwbGV0KCd0ZXN0L3Rlc3QtbXVsdGlzdGFjay55YW1sJykpKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAnZXhwZWN0IGZhaWx1cmUgNCcodGVzdDogVGVzdCkge1xuICAgIHRlc3QudGhyb3dzKCgpID0+IHtcbiAgICAgIHN5bnRoZXNpemVBcHBsZXQoJ3Rlc3QvbmVnYXRpdmUtdGVzdDQueWFtbCcpO1xuICAgIH0sIC9idXQgaXQgbXVzdCBiZSBpbiB0aGUgZm9ybS8pO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICdleHBlY3QgZmFpbHVyZSA1Jyh0ZXN0OiBUZXN0KSB7XG4gICAgdGVzdC50aHJvd3MoKCkgPT4ge1xuICAgICAgc3ludGhlc2l6ZUFwcGxldCgndGVzdC9uZWdhdGl2ZS10ZXN0NS55YW1sJyk7XG4gICAgfSwgL0Nhbm5vdCBmaW5kIG1vZHVsZS8pO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICdleHBlY3QgZmFpbHVyZSA2Jyh0ZXN0OiBUZXN0KSB7XG4gICAgdGVzdC50aHJvd3MoKCkgPT4ge1xuICAgICAgc3ludGhlc2l6ZUFwcGxldCgndGVzdC9uZWdhdGl2ZS10ZXN0Ni55YW1sJyk7XG4gICAgfSwgL0Nhbm5vdCBmaW5kIGFwcGxldCBjbGFzcy8pO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICdleHBlY3QgZmFpbHVyZSA3Jyh0ZXN0OiBUZXN0KSB7XG4gICAgdGVzdC50aHJvd3MoKCkgPT4ge1xuICAgICAgc3ludGhlc2l6ZUFwcGxldCgndGVzdC9uZWdhdGl2ZS10ZXN0Ny55YW1sJyk7XG4gICAgfSwgL2J1dCBpdCBtdXN0IGJlIGluIHRoZSBmb3JtLyk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG59O1xuXG5mdW5jdGlvbiBleHBlY3RNYXRjaCh0ZXN0OiBUZXN0LCBleHBlY3RlZEZpbGU6IHN0cmluZywgc3RhY2s6IGFueSkge1xuICB0cnkge1xuICAgIGNvbnN0IGV4cGVjdGVkID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoZXhwZWN0ZWRGaWxlLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pKTtcbiAgICB0ZXN0LmRlZXBFcXVhbChzdGFjaywgZXhwZWN0ZWQpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGUuY29kZSA9PT0gJ0VOT0VOVCcpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShzdGFjaywgdW5kZWZpbmVkLCAyKSk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1ha2UgYSBmaWxlICR7ZXhwZWN0ZWRGaWxlfSB3aXRoIHRoZSBwcmV2aW91cyBjb250ZW50c2ApO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBzeW50aGVzaXplQXBwbGV0KHlhbWxGaWxlOiBzdHJpbmcsIGRpcmVjdCA9IGZhbHNlKSB7XG4gIC8vIENhbid0IGRlcGVuZCBvbiBhd3MtY2RrIGhlcmUsIHNvIHdlJ3JlIHJlaW1wbGVtZW50aW5nIGN4LWFwaS5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgY29uc29sZS5sb2coJ1dyaXRpbmcgdG8gJywgb3MudG1wZGlyKCkpO1xuXG4gIGNvbnN0IGNvbW1hbmQgPSBkaXJlY3QgPyB5YW1sRmlsZSA6ICdjZGstYXBwbGV0LWpzJztcbiAgY29uc3QgYXJncyA9IGRpcmVjdCA/IFtdIDogW3lhbWxGaWxlXTtcbiAgY29uc3Qgb3V0ZGlyID0gZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCAnY2RrLWFwcGxldC10ZXN0cycpKTtcblxuICBjaGlsZF9wcm9jZXNzLmV4ZWNGaWxlU3luYyhjb21tYW5kLCBhcmdzLCB7XG4gICAgZW52OiB7XG4gICAgICAuLi5wcm9jZXNzLmVudixcbiAgICAgIENES19PVVRESVI6IG91dGRpcixcbiAgICAgIFBBVEg6ICdiaW46JyArIHByb2Nlc3MuZW52LlBBVEhcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4ob3V0ZGlyLCAnY2RrLm91dCcpLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pKTtcbn1cblxuZnVuY3Rpb24gZ2V0U3RhY2soc3RhY2tOYW1lOiBzdHJpbmcsIGFsbFN0YWNrczogYW55KSB7XG4gIGZvciAoY29uc3Qgc3RhY2sgb2YgYWxsU3RhY2tzLnN0YWNrcykge1xuICAgIGlmIChzdGFjay5uYW1lID09PSBzdGFja05hbWUpIHtcbiAgICAgIHJldHVybiBzdHJpcFN0YWNrTWV0YWRhdGEoc3RhY2spO1xuICAgIH1cbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gIGNvbnNvbGUubG9nKGFsbFN0YWNrcyk7XG4gIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZpbmQgc3RhY2s6ICcgKyBzdGFja05hbWUpO1xufVxuXG5mdW5jdGlvbiBzdHJpcFN0YWNrTWV0YWRhdGEoc3RhY2s6IGFueSkge1xuICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhzdGFjay5tZXRhZGF0YSkpIHtcbiAgICBpZiAoIXN0YWNrLm1ldGFkYXRhW2tleV0pIHsgY29udGludWU7IH1cbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIChzdGFjay5tZXRhZGF0YVtrZXldIGFzIGFueVtdKSkge1xuICAgICAgaWYgKGVudHJ5LnRyYWNlKSB7IGVudHJ5LnRyYWNlID0gWycqKlJFREFDVEVEKionXTsgfVxuICAgIH1cbiAgfVxuICBkZWxldGUgc3RhY2suZW52aXJvbm1lbnQ7XG4gIHJldHVybiBzdGFjaztcbn0iXX0=